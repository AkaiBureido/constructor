#!/usr/bin/env ruby

######################################################
# TODO: Read the configuration from file
# TODO: Populate default folder with sample templates.
# TODO: Check the template from arguments. 
#
# NOTE: BUT ABOVE ALL!!!!!!!!!!!!!!!!!
# TODO: Refactor this sucker!
######################################################

require 'pry'

# Default constants:
TEMPLATE_CATEGORY_SEPARATOR = "."
TEMPLATE_BASE_PATH          = File.expand_path "~/.construct"

# check if default folder exists
# TODO: Create a directory if it does not exist.
if Dir.exist? TEMPLATE_BASE_PATH
    puts "I'm on the boat!"
else
    puts "Creating the default folder..."
    FileUtils.mkdir TEMPLATE_BASE_PATH
end

# TODO:deal with arguments
# first argument is the tempalte name:
first_parameter = ARGV.shift

case first_parameter

when "make"
    template_offset_path = ARGV.shift.split(TEMPLATE_CATEGORY_SEPARATOR) 

    # lets find the node in the file system 
    requested_template_path = 
        TEMPLATE_BASE_PATH + 
        "/" + template_offset_path.join("/")

    # there are a few possibilities now
    # the template can be:
    # * or a plain file with instructions
    # * a directory
    # * a zip file

    template_type = nil
    if File.exists? requested_template_path
        template_type = :instruction_file
    elsif Dir.exists? requested_template_path
        template_type = :directory
    elsif File.exists? requested_template_path + ".zip"
        template_type = :zip_ball
    else
        puts "Error: the requested template #{requested_template_path} does not exist!"
        exit
    end
    
    # Now that we know the file type leets act accordingly
    case template_type
    when :instruction_file
        # TODO: Figure out syntax
        #
        # Assumptions to make coding easier for now:
        # * indents are 4 space wide.
        #
        # Every thing that follows # is considered a comment
        
        File.open( requested_template_path , "r" ) { |template_file|
            # get all lines and delete empty ones
            contents = (template_file.read.split("\n").delete_if { |a| a.empty? })

            # First line must contain type in form of '# Type:<type>'
            # Type acn be either:
            # * constructor - my own script language for this task
            # * shell       - self explanatory really
            script_type = contents.shift.match(%r{Type:\s*(\w+)})[1].to_sym

            # TODO: Write both shell and constructo implementations
        }

    when :directory
        # TODO: Simply copy the directory
        
    when :zip_ball
        # TODO: Unpack the zip into folder
    else
    end
    puts template_type

    binding.pry
# case "~~~~~~~"
    # TODO: Implement:
    # add    - adding a new template with editor, perhaps some cursing and black magic...
    # remove - removing a template
else
    puts "Error: Unknown command! See nonexistent help!"
end


# vim:ft=ruby
